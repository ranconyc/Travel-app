generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
}

/**
 * -------------------------- USER ---------------------------
 */
model User {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  /**
   * ---- INFO ----
   */
  email            String?        @unique
  name             String?
  firstName        String?
  lastName         String?
  homeBaseCityId   String?        @db.ObjectId
  homeBaseCity     City?          @relation("HomeBase", fields: [homeBaseCityId], references: [id])
  occupation       String?
  birthday         DateTime?
  description      String?
  gender           Gender?
  emailVerified    DateTime?
  image            String?
  passwordHash     String?
  profileCompleted Boolean        @default(false)
  /**
   * ---- LANGUAGE ----
   */
  languages        UserLanguage[] @relation("UserLanguages") // Many-to-many via explicit join
  /**
   * ---- AUTH ----
   */
  accounts         Account[]
  sessions         Session[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  /**
   * ---- DESTINATIONS ----
   */
  currentLocation  Json? // { type: "Point", coordinates: [lng, lat] }? 
  currentCityId    String?        @db.ObjectId
  currentCity      City?          @relation("CurrentLocation", fields: [currentCityId], references: [id])

  /**
   * ---- TRAVEL INTERESTS ----
   */
  interests     UserInterest[]
  /**
   * ---- TRAVEL PERSONA ----
   */
  travelPersona TravelPersona?

  /**
   * ---- TRAVEL HISTORY ----
   */
  visitedCities  UserVisitedCity[]
  /**
   * ---- WISHLIST ----
   */
  wishListCities UserWishlistCity[]
  /**
   * ---- FRIENDSHIP ----
   */
}

model TravelPersona {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  userId             String   @unique @db.ObjectId
  areaPriorities     String[] // ["convenience", "nightlife"]
  accommodationTypes String[] // ["hostel", "hotel"]
  dailyRhythm        String? // "night_owl"
  travelStyle        String? // "balanced"
  user               User     @relation(fields: [userId], references: [id])
}

model Account {
  id                 String  @id @default(auto()) @map("_id") @db.ObjectId
  userId             String  @db.ObjectId
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String? @map("refresh_token")
  access_token       String? @map("access_token")
  expires_at         Int?    @map("expires_at")
  token_type         String?
  scope              String?
  id_token           String? @map("id_token")
  session_state      String? @map("session_state")
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/**
 * ------------------------ LANGUAGE -------------------------
 */
model Language {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  code       String  @unique // e.g. "en"
  name       String // e.g. "English"
  nativeName String? // e.g. "L√´tzebuergesch"
  flag       String? // e.g. "üá±üá∫" or "üåê"

  users UserLanguage[] @relation("UserLanguages")
}

/**
 * --------------- EXPLICIT JOIN (Mongo-friendly) ------------
 */
model UserLanguage {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId     String @db.ObjectId
  languageId String @db.ObjectId

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade, name: "UserLanguages")
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade, name: "UserLanguages")

  proficiency String? @default("fluent") // "native" | "fluent" | "conversational" | "basic"

  @@unique([userId, languageId])
  @@index([userId])
  @@index([languageId])
}

/**
 * ------------------------- COUNTRY -------------------------
 */

model Country {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  countryId String @unique
  code      String
  name      String

  continent     String?
  subRegion     String?
  officialName  String?
  capital       String?
  regionCode    String?
  subRegionCode String?
  population    Int?
  areaKm2       Float?

  currency      Json?
  emergency     Json?
  visaEntry     Json?
  languageComm  Json?
  utilities     Json?
  internet      Json?
  gettingAround Json?

  imageHeroUrl  String?
  images        String[] @default([])

  bestSeason    String?
  idealDuration String?
  safety        String?

  regions String[] @default([])

   // Capital relation (one-to-one)
  capitalCityRefId String? @unique @db.ObjectId
  capitalCity      City?  @relation("CountryCapital", fields: [capitalCityRefId], references: [id], onDelete: NoAction, onUpdate: NoAction)


  // Relations
  cities     City[]
  activities Activity[]

  autoCreated Boolean @default(false)
  needsReview Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


 /* ------------------------- CITY ------------------------- */

model City {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  cityId       String  @unique
  name         String
  countryRefId String  @db.ObjectId
  country      Country @relation(fields: [countryRefId], references: [id], onDelete: Cascade)

  // Capital inverse relation (optional but nice)
  isCapital        Boolean  @default(false)
  countryAsCapital Country? @relation("CountryCapital")

  // Geo
  coords      Json
  radiusKm    Int     @default(30)
  timeZone    String?
  boundingBox Json?

  // Media
  imageHeroUrl String?
  images       String[] @default([])

  // Meta
  state       String?
  district    String?
  population  Int?
  bestSeason    String?
  idealDuration String?
  safety        String?
  neighborhoods String[] @default([])
  budget        Json?
  gettingAround Json?

  activities Activity[]

  usersHomeBase     User[]             @relation("HomeBase")
  usersCurrentCity  User[]             @relation("CurrentLocation")
  visitedByUsers    UserVisitedCity[]
  wishListedByUsers UserWishlistCity[]

  autoCreated Boolean @default(false)
  needsReview Boolean @default(false)

  @@index([countryRefId])
}

 /* ------------------------- ACTIVITY -------------------------*/

model Activity {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  activityId String  @unique // "chatuchak-weekend-market"
  name       String
  shortName  String?
  slug       String  @unique

  // Relations
  cityRefId String @db.ObjectId
  city      City   @relation(fields: [cityRefId], references: [id], onDelete: Cascade)

  // Optional denorm for filtering/joins
  countryRefId String?  @db.ObjectId
  country      Country? @relation(fields: [countryRefId], references: [id], onDelete: Cascade)

  type       String // enum-like in app code
  categories String[] // ["shopping","street-food"]

  // Location
  address      String?
  coords       Json // GeoJSON { type: "Point", coordinates: [lng, lat] }
  timeZone     String?
  neighborhood String?

  // Ops
  openingHours         Json? // WeeklyHours (see TS)
  bestTimeToVisit      String?
  typicalVisitDuration String?

  // Price
  entryPrice Json? // { currencyCode, range, note, badges }

  // UX
  amenities     String[]
  accessibility String?
  safetyNotes   String?
  crowdLevel    String? // "low"|"moderate"|"busy"|"very-busy"
  haggling      String? // "expected" etc.
  photoTips     String[]

  // Media
  images Json? // { heroUrl, thumbUrl, gallery }

  // CMS
  summary    String?
  highlights String[]
  tags       String[]

  // data for auto-created activity
  autoCreated Boolean @default(false)
  needsReview Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cityRefId])
  @@index([countryRefId])
  @@index([type])
}

model InterestCategory {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  slug      String     @unique
  title     String
  order     Int        @default(0)
  interests Interest[]
}

model Interest {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  slug       String           @unique
  label      String
  category   InterestCategory @relation(fields: [categoryId], references: [id])
  categoryId String           @db.ObjectId
  users      UserInterest[]
}

model UserInterest {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  interestId String   @db.ObjectId
  weight     Float    @default(1)
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@unique([userId, interestId])
  @@index([userId])
  @@index([interestId])
}

model UserVisitedCity {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  cityId    String   @db.ObjectId
  visitedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  city City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@unique([userId, cityId])
  @@index([userId])
  @@index([cityId])
}

model UserWishlistCity {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  userId  String   @db.ObjectId
  cityId  String   @db.ObjectId
  addedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  city City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@unique([userId, cityId])
  @@index([userId])
  @@index([cityId])
}
