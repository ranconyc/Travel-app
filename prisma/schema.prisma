generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  NON_BINARY
}

enum Role {
  USER
  ADMIN
}

/**
 * -------------------------- USER ---------------------------
 */
model User {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  /* ---- INFO ---- */
  email            String?        @unique
  role             Role           @default(USER)
  name             String?
  firstName        String?
  lastName         String?
  homeBaseCityId   String?        @db.ObjectId
  homeBaseCity     City?          @relation("HomeBase", fields: [homeBaseCityId], references: [id])
  occupation       String?
  birthday         DateTime?
  description      String?
  gender           Gender?
  emailVerified    DateTime?
  image            String?
  imagePublicId    String?
  passwordHash     String?
  profileCompleted Boolean        @default(false)

   /* ---- LANGUAGE ---- */
  languages String[] @default([]) // ['en','es']

   /* ---- AUTH ---- */
  accounts         Account[]
  sessions         Session[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  /** ---- DESTINATIONS ---- */
 
  currentLocation  Json?
  currentCityId    String?        @db.ObjectId
  currentCity      City?          @relation("CurrentLocation", fields: [currentCityId], references: [id])

  /* ---- TRAVEL INTERESTS ---- */
  interestsData     Json?  //{ "Shopping": ["id1", "id2"] }
 
  /* ---- TRAVEL PERSONA ---- */
  dailyRhythm     String?  // "early_riser", "night_owl"
  travelStyle     String?  // "relaxed", "adventurous"
  /* ---- TRAVEL HISTORY ---- */
  trips Trip[] @relation("UserTrips")
  /* ---- FRIENDSHIP ---- */

  friendshipsRequested Friendship[] @relation("FriendshipsRequested")
  friendshipsReceived Friendship[] @relation("FriendshipsReceived")

  // --- CHAT FEATURE ADDITIONS ---
  chats            ChatMember[] // Links user to all their chats
  sentMessages     Message[]    @relation("SentMessages") // Messages sent by the user
}


model Account {
  id                 String  @id @default(auto()) @map("_id") @db.ObjectId
  userId             String  @db.ObjectId
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?        @map("refresh_token")
  access_token       String?        @map("access_token")
  expires_at         Int?           @map("expires_at")
  token_type         String?
  scope              String?
  id_token           String?        @map("id_token")
  session_state      String?        @map("session_state")
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}




/**
 * ------------------------- COUNTRY -------------------------
 */

model Country {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  countryId String @unique
  code      String
  name      String

  coords    Json?

  continent     String?
  subRegion     String?
  officialName  String?
  capital       String?
  regionCode    String?
  subRegionCode String?
  population    Int?
  areaKm2       Float?
  currency      Json?
  emergency     Json?
  visaEntry     Json?
  languageComm  Json?
  utilities     Json?
  internet      Json?
  gettingAround Json?
  imageHeroUrl  String?
  images        String[] @default([])

  bestSeason    String?
  idealDuration String?
  safety        String?

  meta Json?
  regions String[] @default([])

   // Capital relation (one-to-one)
  capitalCityRefId String?        @db.ObjectId
  // capitalCity      City?          @relation("CountryCapital", fields: [capitalCityRefId], references: [id], onDelete: NoAction, onUpdate: NoAction)


  // Relations
  cities     City[]
  activities Activity[]

  autoCreated Boolean @default(false)
  needsReview Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


 /* ------------------------- CITY ------------------------- */

model City {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  cityId       String  @unique
  name         String
  countryRefId String?  @db.ObjectId
  country      Country? @relation(fields: [countryRefId], references: [id], onDelete: Cascade)

  // Capital inverse relation (optional but nice)
  isCapital        Boolean  @default(false)
  // countryAsCapital Country?        @relation("CountryCapital")

  // Geo
  coords      Json
  radiusKm    Int     @default(30)
  timeZone    String?
  boundingBox Json?

  // Media
  imageHeroUrl String?
  images       String[] @default([])

  // Meta
  state       String?
  district    String?
  population  Int?
  bestSeason    String?
  idealDuration String?
  safety        String?
  neighborhoods String[] @default([])
  budget        Json?
  gettingAround Json?

  activities Activity[]

  usersHomeBase     User[]             @relation("HomeBase")
  usersCurrentCity  User[]             @relation("CurrentLocation")
  tripStops         TripStop[]

  autoCreated Boolean @default(false)
  needsReview Boolean @default(false)

  @@index([countryRefId])
}

 /* ------------------------- ACTIVITY -------------------------*/

model Activity {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  activityId String  @unique // "chatuchak-weekend-market"
  name       String
  shortName  String?
  slug       String  @unique

  // Relations
  cityRefId String @db.ObjectId
  city      City   @relation(fields: [cityRefId], references: [id], onDelete: Cascade)

  // Optional denorm for filtering/joins
  countryRefId String?        @db.ObjectId
  country      Country?        @relation(fields: [countryRefId], references: [id], onDelete: Cascade)

  type       String // enum-like in app code
  categories String[] // ["shopping","street-food"]

  // Location
  address      String?
  coords       Json // GeoJSON { type: "Point", coordinates: [lng, lat] }
  timeZone     String?
  neighborhood String?

  // Ops
  openingHours         Json? // WeeklyHours (see TS)
  bestTimeToVisit      String?
  typicalVisitDuration String?

  // Price
  entryPrice Json? // { currencyCode, range, note, badges }

  // UX
  amenities     String[]
  accessibility String?
  safetyNotes   String?
  crowdLevel    String? // "low"|"moderate"|"busy"|"very-busy"
  haggling      String? // "expected" etc.
  photoTips     String[]

  // Media
  images Json? // { heroUrl, thumbUrl, gallery }

  // CMS
  summary    String?
  highlights String[]
  tags       String[]

  // data for auto-created activity
  autoCreated Boolean @default(false)
  needsReview Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tripActivities TripActivity[]

  @@index([cityRefId])
  @@index([countryRefId])
  @@index([type])
}



 /* ------------------------- Trip -------------------------*/
enum TripType {
  VISITED   // Historical travel (replaces UserVisitedCity)
  WISHLIST  // Future aspiration (replaces UserWishlistCity)
  PLANNED   // Detailed future itinerary
}

enum TripStatus {
  DRAFT
  ACTIVE
  COMPLETED
  PUBLISHED
}

model Trip {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  userId      String      @db.ObjectId
  type        TripType
  status      TripStatus  @default(DRAFT)

  name        String?
  imageUrl    String?

  startDate   DateTime?
  endDate     DateTime?

  user        User        @relation("UserTrips", fields: [userId], references: [id], onDelete: Cascade)
  stops       TripStop[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId, type])
}


model TripStop {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  tripId          String   @db.ObjectId
  cityId          String   @db.ObjectId

  arrivalDate     DateTime?
  departureDate   DateTime?
  title           String?
  notes           String?

  trip            Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  city            City     @relation(fields: [cityId], references: [id], onDelete: Cascade)

  activities      TripActivity[]

  @@index([tripId])
  @@index([cityId])
}


model TripActivity {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId

  tripStopId String   @db.ObjectId
  tripStop   TripStop @relation(fields: [tripStopId], references: [id], onDelete: Cascade)

  // Optional catalog link
  activityId String?    @db.ObjectId
  activity   Activity?  @relation(fields: [activityId], references: [id])

  name        String
  date        DateTime
  startTime   String?
  notes       String?
  duration    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tripStopId])
}




/* ------------------------- FRIENDSHIP -------------------------*/
enum FriendStatus {
  PENDING   // request sent, waiting for response
  ACCEPTED  // you are friends
  DENIED    // request was rejected
  BLOCKED   // one side blocked the other
}

model Friendship {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId

  requesterId String       @db.ObjectId   // user who sent the request
  addresseeId String       @db.ObjectId   // user who receives the request
  status      FriendStatus @default(PENDING)

  // who blocked whom (only used when status = BLOCKED)
  blockedById String?      @db.ObjectId

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  requester   User @relation("FriendshipsRequested", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee   User @relation("FriendshipsReceived", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([requesterId])
  @@index([addresseeId])
  @@index([status])
}

/* ---------------------------- CHAT ----------------------------- */

model Chat {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  isGroup         Boolean        @default(false)
  groupName       String?        // Name for group chats
  groupImage      String?        // Optional image URL for group chats
  
  // Relations
  members         ChatMember[]   // Links to users in this chat
  messages        Message[]      @relation("ChatMessages") // All messages in this chat

  // Last message for quick list display
  lastMessageId   String?        @db.ObjectId
  lastMessage     Message?       @relation("ChatLastMessage", fields: [lastMessageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model ChatMember {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  chatId          String    @db.ObjectId
  userId          String    @db.ObjectId
  
  // To track where a user last left off (useful for unread counts)
  lastReadAt      DateTime? 
  
  // Relations
  chat            Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([chatId, userId])
  @@index([userId])
}

model Message {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  chatId          String    @db.ObjectId
  senderId        String    @db.ObjectId
  content         String    // The message text
  
  // Array of user IDs who have read the message
  readBy          String[]  @db.ObjectId 
  
  // Relations
  chat            Chat      @relation("ChatMessages", fields: [chatId], references: [id], onDelete: Cascade)
  sender          User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())

  // For the `lastMessage` relationship on the Chat model
  chatLastMessage Chat[]    @relation("ChatLastMessage")
  
  @@index([chatId])
  @@index([senderId])
}




/* ---------------------------- SEARCH ----------------------------- */
model SearchEvent {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  userId            String?   // User's ID if logged in (optional)
  sessionId         String    // Session identifier
  searchQuery       String
  timestamp         DateTime  @default(now())
  resultCount       Int
  clickedResultIndex Int?     // Null if no result was clicked
  pagePath          String?
}