// ============================================
// LOCATION DOMAIN
// ============================================
// Geographic hierarchy: Country → State → City → Place

model Country {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  cca3          String   @unique // "ISR"
  code          String   // "IL"
  name          String   // "Israel"
  officialName  String?  // "State of Israel"
  imageHeroUrl  String?

  // Demographics
  population    Int?     // 10119400
  areaKm2       Float?   // 21937
  region        String?  // "Asia"
  subRegion     String?  // "Western Asia"
  
  // Status Flags
  isIndependent Boolean? // true
  isUnMember    Boolean? // true
  landlocked    Boolean? // false
  
  // Arrays & Objects
  borders       String[] // ["EGY", "JOR", ...]
  altSpellings  String[] // ["IL", "State of Israel", ...]
  
  // Complex Objects (Stored as JSON)
  maps          Json?    // { googleMaps, openStreetMaps }
  flags         Json?    // { png, svg, alt }
  coatOfArms    Json?    // { png, svg }
  demonyms      Json?    // { eng: { f, m }, ... }
  coords        Json?    // { type: "Point", coordinates: [lng, lat] }
  
  // Domain Data (JSON)
  // 1. LOGISTICS: { idd: { root, suffixes }, timezones: [], car: { side, signs }, startOfWeek }
  logistics     Json?    
  
  // 2. FINANCE: { currency: { code, name, symbol }, gini: { "2016": 39 } }
  finance       Json?    
  
  // 3. LANGUAGES: { ara: "Arabic", heb: "Hebrew" } - Map of code -> name
  languages     Json?

  // 4. Other JSON fields from previous schema (kept for safety if they exist in other records)
  safety        Json?
  emergency     Json?
  health        Json?
  seasons       Json?
  tld           Json?
  idd           Json?
  translations  Json?
  gini          Json?

  // Geography & Relations
  capitalName   String?  // "Jerusalem"
  capitalId     String?  @db.ObjectId
  capitalCity   City?    @relation("CountryCapital", fields: [capitalId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  // Relations
  states        State[]
  cities        City[]
  places        Place[]
  media         Media[]

  needsReview   Boolean  @default(false)
  autoCreated   Boolean  @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([coords], map: "coords_2dsphere")
}

/**
 * ------------------------- STATE / PROVINCE -------------------------
 */
model State {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  stateId      Int?     @unique // ID from countries+states+cities.json
  name         String
  native       String?
  code         String?  // "BDS", "CA"
  type         String?  // "province", "state", etc.
  
  countryRefId String   @db.ObjectId
  country      Country  @relation(fields: [countryRefId], references: [id], onDelete: Cascade)

  coords       Json?    // { type: "Point", coordinates: [lng, lat] }
  translations Json?

  cities       City[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([countryRefId])
}

/**
 * ------------------------- CITY -------------------------
 */
model City {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  cityId       String   @unique // "bangkok-thailand"
  externalId   Int?     @unique // ID from countries+states+cities.json
  name         String

  countryRefId String?  @db.ObjectId
  country      Country? @relation(fields: [countryRefId], references: [id], onDelete: Cascade)

  isCapital Boolean @default(false)

  // NEW FIELDS
  googlePlaceId String? @unique
  isVerified    Boolean @default(false)
  slug          String  @unique // format: country-city-name
  priority      Int     @default(0)

  // Geo
  coords      Json // GeoJSON Point
  radiusKm    Int     @default(30)
  timeZone    String?
  boundingBox Json? // { sw: [lng, lat], ne: [lng, lat] } - Crucial for map zoom

  // Media
  imageHeroUrl String?
  media        Media[]

  // Meta
  stateName     String?  // Legacy or free text
  stateId       String?  @db.ObjectId
  state         State?   @relation(fields: [stateId], references: [id])
  district      String?
  population    Int?
  
  neighborhoods String[] @default([])

  places Place[]

  // User Relations
  usersHomeBase    UserProfile[] @relation("HomeBase")
  usersCurrentCity User[]        @relation("CurrentLocation")
  
  // Travel History
  cityVisits CityVisit[]

  autoCreated Boolean @default(false)
  needsReview Boolean @default(false)

  aggregatedVibes String[]
  discoveryScore  Float    @default(0.0)

  capitalOf Country[] @relation("CountryCapital")

  @@index([countryRefId])
  @@index([stateId])
  @@index([coords], map: "coords_2dsphere")
}

/**
 * ------------------------- PLACE (Formerly Activity) -------------------------
 */
model Place {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  slug    String @unique // "chatuchak-weekend-market"
  name    String
  altName String?

  // Relations
  cityRefId String @db.ObjectId
  city      City   @relation(fields: [cityRefId], references: [id], onDelete: Cascade)

  countryRefId String?  @db.ObjectId
  country      Country? @relation(fields: [countryRefId], references: [id], onDelete: Cascade)

  // Classification
  type       String // "RESTAURANT", "LANDMARK", "MUSEUM"
  categories String[] // ["street-food", "history"]
  mapIcon    String?  // "cutlery", "camera", "bed" - For map rendering

  // Location
  address      String?
  coords       Json // GeoJSON { type: "Point", coordinates: [lng, lat] }
  timeZone     String?
  neighborhood String?

  // Contact / Info (New Traveler Fields)
  websiteUrl    String?
  phoneNumber   String?
  googlePlaceId String? @unique
  
  // Ops
  openingHours         Json? // Structured weekly hours
  isPermanentlyClosed  Boolean @default(false)
  
  bestTimeToVisit      String?
  typicalVisitDuration String?

  // Social Proof (Aggregated)
  rating      Float? @default(0.0)
  reviewCount Int    @default(0)

  // Price
  entryPrice Json? // { currencyCode, range: "$-$$$$", exact: 100 }

  // UX & Vibe
  amenities     String[] // "wifi", "ac", "parking"
  vibe          String[] // "quiet", "crowded", "touristy"
  accessibility String?
  safetyNotes   String?
  
  // Media
  imageHeroUrl String? // Quick access cover
  media        Media[] // Full gallery

  // CMS Content
  summary    String?
  highlights String[]
  tags       String[]

  autoCreated Boolean @default(true)
  needsReview Boolean @default(false)

  googleData  Json?
  priceLevel  Int?
  vibeScores  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cityRefId])
  @@index([countryRefId])
  @@index([type])
  @@index([coords], map: "coords_2dsphere") // Geo index for "places near me"
}
